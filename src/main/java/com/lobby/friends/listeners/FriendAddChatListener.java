package com.lobby.friends.listeners;

import com.lobby.LobbyPlugin;
import com.lobby.core.DatabaseManager;
import com.lobby.friends.data.FriendData;
import com.lobby.friends.data.FriendRequest;
import com.lobby.friends.manager.BlockedPlayersManager;
import com.lobby.friends.manager.FriendCodeManager;
import com.lobby.friends.manager.FriendsManager;
import com.lobby.friends.menu.BlockedPlayersMenu;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.player.AsyncPlayerChatEvent;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.UUID;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ConcurrentHashMap;

public class FriendAddChatListener implements Listener {

    private static final String MODE_SEARCH_PLAYER_NAME = "search_player_name";
    private static final String MODE_FRIEND_CODE = "friend_code";

    private final LobbyPlugin plugin;
    private final FriendsManager friendsManager;
    private final Map<UUID, String> pendingRequests = new ConcurrentHashMap<>();
    private final Map<UUID, String> messageTargets = new ConcurrentHashMap<>();
    private final Map<UUID, UUID> pendingBlockReasons = new ConcurrentHashMap<>();

    public FriendAddChatListener(final LobbyPlugin plugin) {
        this.plugin = plugin;
        this.friendsManager = plugin.getFriendsManager();
    }

    public void activateMessageMode(final Player player, final String friendName) {
        if (player == null || friendName == null || friendName.isBlank()) {
            return;
        }
        messageTargets.put(player.getUniqueId(), friendName);
    }

    @EventHandler(priority = EventPriority.HIGHEST)
    public void onPlayerChat(final AsyncPlayerChatEvent event) {
        final Player player = event.getPlayer();
        final UUID playerUUID = player.getUniqueId();

        if (messageTargets.containsKey(playerUUID)) {
            event.setCancelled(true);
            handlePrivateMessageInput(player, event.getMessage());
            return;
        }

        if (pendingBlockReasons.containsKey(playerUUID)) {
            event.setCancelled(true);
            handleBlockReasonChange(event);
            return;
        }

        if (!pendingRequests.containsKey(playerUUID)) {
            return;
        }

        event.setCancelled(true);

        final String mode = pendingRequests.get(playerUUID);
        final String input = event.getMessage().trim();

        if (input.equalsIgnoreCase("annuler") || input.equalsIgnoreCase("cancel")) {
            pendingRequests.remove(playerUUID);
            Bukkit.getScheduler().runTask(plugin, () -> player.sendMessage("¬ßc‚ùå Ajout d'ami annul√©"));
            return;
        }

        pendingRequests.remove(playerUUID);

        if (MODE_SEARCH_PLAYER_NAME.equals(mode)) {
            handleAddByName(player, input);
            return;
        }

        if (MODE_FRIEND_CODE.equals(mode)) {
            handleAddByCode(player, input);
            return;
        }

        Bukkit.getScheduler().runTask(plugin, () -> player.sendMessage("¬ßc‚ùå Mode d'ajout non reconnu !"));
    }

    public void activateBlockReasonMode(final Player player, final UUID blockedPlayerUUID) {
        if (player == null || blockedPlayerUUID == null) {
            return;
        }

        final UUID playerUUID = player.getUniqueId();
        pendingBlockReasons.put(playerUUID, blockedPlayerUUID);

        final String blockedPlayerName = getPlayerName(blockedPlayerUUID);

        player.sendMessage("¬ßeüìù ¬ß6Modification de la raison de blocage");
        player.sendMessage("¬ß7Joueur bloqu√©: ¬ßc" + blockedPlayerName);
        player.sendMessage("");
        player.sendMessage("¬ß6Tapez la nouvelle raison de blocage :");
        player.sendMessage("¬ß7Exemple: ¬ßeComportement toxique en jeu");
        player.sendMessage("¬ß7Exemple: ¬ßeSpam de messages r√©p√©t√©s");
        player.sendMessage("¬ß7Exemple: ¬ßeLanguage inappropri√©");
        player.sendMessage("");
        player.sendMessage("¬ß7Tapez ¬ßc'annuler'¬ß7 pour annuler la modification");

        plugin.getLogger().info("Mode modification raison activ√© pour " + player.getName()
                + " -> " + blockedPlayerName);

        Bukkit.getScheduler().runTaskLater(plugin, () -> {
            if (pendingBlockReasons.containsKey(playerUUID)) {
                pendingBlockReasons.remove(playerUUID);
                player.sendMessage("¬ßc‚è∞ ¬ß7Modification de raison expir√©e - ¬ßcAucun changement effectu√©");
            }
        }, 20L * 60);
    }

    private void handleBlockReasonChange(final AsyncPlayerChatEvent event) {
        final Player player = event.getPlayer();
        final UUID playerUUID = player.getUniqueId();
        final String rawMessage = event.getMessage();
        final String newReason = rawMessage == null ? "" : rawMessage.trim();

        final UUID blockedPlayerUUID = pendingBlockReasons.remove(playerUUID);
        if (blockedPlayerUUID == null) {
            plugin.getLogger().warning("Aucune cible pour la modification de raison de " + player.getName());
            return;
        }

        final String blockedPlayerName = getPlayerName(blockedPlayerUUID);

        plugin.getLogger().info("Tentative modification raison par " + player.getName()
                + " pour " + blockedPlayerName + ": " + newReason);

        if ("annuler".equalsIgnoreCase(newReason) || "cancel".equalsIgnoreCase(newReason)) {
            player.sendMessage("¬ßc‚ùå Modification de raison annul√©e");
            player.sendMessage("¬ß7Aucun changement n'a √©t√© effectu√©");
            return;
        }

        if (newReason.length() < 3) {
            player.sendMessage("¬ßc‚ùå La raison doit contenir au moins 3 caract√®res !");
            player.sendMessage("¬ß7Tapez une raison plus d√©taill√©e pour justifier le blocage");
            activateBlockReasonMode(player, blockedPlayerUUID);
            return;
        }

        if (newReason.length() > 100) {
            player.sendMessage("¬ßc‚ùå La raison ne peut pas d√©passer 100 caract√®res !");
            player.sendMessage("¬ß7Actuel: " + newReason.length() + " caract√®res");
            player.sendMessage("¬ß7Tapez une raison plus courte et concise");
            activateBlockReasonMode(player, blockedPlayerUUID);
            return;
        }

        final BlockedPlayersManager blockedPlayersManager = plugin.getBlockedPlayersManager();
        if (blockedPlayersManager == null
                || !blockedPlayersManager.isPlayerBlocked(playerUUID, blockedPlayerUUID)) {
            player.sendMessage("¬ßc‚ùå Ce joueur n'est plus bloqu√© !");
            player.sendMessage("¬ß7Impossible de modifier la raison d'un joueur non-bloqu√©");
            return;
        }

        player.sendMessage("¬ße‚è≥ Mise √† jour de la raison en cours...");

        Bukkit.getScheduler().runTaskAsynchronously(plugin, () -> {
            final boolean success = blockedPlayersManager.updateBlockReason(playerUUID, blockedPlayerUUID, newReason);

            Bukkit.getScheduler().runTask(plugin, () -> {
                if (success) {
                    player.sendMessage("¬ßa‚úÖ ¬ß2Raison de blocage mise √† jour avec succ√®s !");
                    player.sendMessage("¬ß7Joueur: ¬ßc" + blockedPlayerName);
                    player.sendMessage("¬ß7Nouvelle raison: ¬ßf\"" + newReason + "\"");
                    player.sendMessage("¬ß7Mise √† jour: ¬ßa" + getCurrentTimestamp());

                    player.playSound(player.getLocation(), "block.note_block.chime", 0.7f, 1.2f);

                    Bukkit.getScheduler().runTaskLater(plugin, () -> {
                        try {
                            player.sendMessage("¬ß7R√©ouverture du menu des joueurs bloqu√©s...");
                            new BlockedPlayersMenu(plugin, friendsManager, player).open();
                        } catch (final Exception exception) {
                            plugin.getLogger().warning("Erreur r√©ouverture menu bloqu√©s: " + exception.getMessage());
                            player.sendMessage("¬ß7Utilisez ¬ße/friends blocked¬ß7 pour voir vos joueurs bloqu√©s");
                        }
                    }, 40L);
                } else {
                    player.sendMessage("¬ßc‚ùå ¬ß4Erreur lors de la mise √† jour de la raison !");
                    player.sendMessage("¬ß7La base de donn√©es n'a pas pu √™tre mise √† jour");
                    player.sendMessage("¬ß7Veuillez r√©essayer plus tard ou contacter un administrateur");
                    player.playSound(player.getLocation(), "block.note_block.bass", 0.7f, 0.8f);
                }
            });
        });
    }

    public boolean isInBlockReasonMode(final Player player) {
        return player != null && pendingBlockReasons.containsKey(player.getUniqueId());
    }

    public void cancelBlockReasonMode(final Player player) {
        if (player == null) {
            return;
        }
        final UUID removed = pendingBlockReasons.remove(player.getUniqueId());
        if (removed != null) {
            player.sendMessage("¬ßc‚ùå Modification de raison annul√©e pour " + getPlayerName(removed));
        }
    }

    public UUID getCurrentBlockReasonTarget(final Player player) {
        if (player == null) {
            return null;
        }
        return pendingBlockReasons.get(player.getUniqueId());
    }

    private void handlePrivateMessageInput(final Player player, final String rawInput) {
        final UUID playerUuid = player.getUniqueId();
        final String friendName = messageTargets.remove(playerUuid);

        if (friendName == null) {
            return;
        }

        final String message = rawInput == null ? "" : rawInput.trim();
        if (message.equalsIgnoreCase("annuler") || message.equalsIgnoreCase("cancel")) {
            Bukkit.getScheduler().runTask(plugin, () -> player.sendMessage("¬ßc‚ùå Message annul√©"));
            return;
        }

        if (message.isEmpty()) {
            Bukkit.getScheduler().runTask(plugin, () -> player.sendMessage("¬ßc‚ùå Message vide ignor√©"));
            return;
        }

        final Player target = Bukkit.getPlayerExact(friendName);
        if (target == null) {
            Bukkit.getScheduler().runTask(plugin, () -> player.sendMessage("¬ßc‚ùå " + friendName + " n'est plus en ligne"));
            return;
        }

        Bukkit.getScheduler().runTask(plugin, () -> {
            final String formatted = "¬ßd‚úâ ¬ß5" + player.getName() + "¬ß7: ¬ßf" + message;
            target.sendMessage(formatted);
            target.playSound(target.getLocation(), "entity.experience_orb.pickup", 0.6f, 1.5f);
            player.sendMessage("¬ßd‚úâ ¬ß7Vous ‚Üí ¬ß5" + friendName + "¬ß7: ¬ßf" + message);
            player.playSound(player.getLocation(), "block.note_block.pling", 0.8f, 1.6f);
        });
    }

    private void handleAddByName(final Player player, final String targetName) {
        if (targetName.length() < 3 || targetName.length() > 16) {
            player.sendMessage("¬ßc‚ùå Nom d'utilisateur invalide ! (3-16 caract√®res requis)");
            return;
        }

        if (!targetName.matches("[a-zA-Z0-9_]+")) {
            player.sendMessage("¬ßc‚ùå Le nom ne peut contenir que des lettres, chiffres et _ !");
            return;
        }

        Bukkit.getScheduler().runTaskAsynchronously(plugin, () -> {
            final UUID targetUUID = getPlayerUUID(targetName);

            if (targetUUID == null) {
                Bukkit.getScheduler().runTask(plugin, () -> {
                    player.sendMessage("¬ßc‚ùå Joueur '" + targetName + "' introuvable !");
                    player.sendMessage("¬ß7V√©rifiez l'orthographe du nom d'utilisateur");
                });
                return;
            }

            Bukkit.getScheduler().runTask(plugin, () -> processFriendRequest(player, targetUUID, targetName));
        });
    }

    private void handleAddByCode(final Player player, final String rawInput) {
        final FriendCodeManager friendCodeManager = plugin.getFriendCodeManager();
        if (friendCodeManager == null) {
            Bukkit.getScheduler().runTask(plugin, () ->
                    player.sendMessage("¬ßc‚ùå Le syst√®me de codes d'amis est indisponible."));
            return;
        }

        final String normalized = normalizeFriendCode(rawInput);
        if (normalized == null) {
            Bukkit.getScheduler().runTask(plugin, () -> {
                player.sendMessage("¬ßc‚ùå Format de code invalide !");
                player.sendMessage("¬ß7Le format correct est ¬ßdXXXX-YYYY¬ß7.");
            });
            return;
        }

        final UUID senderUuid = player.getUniqueId();
        Bukkit.getScheduler().runTaskAsynchronously(plugin, () -> {
            final UUID targetUuid = friendCodeManager.getPlayerByCode(normalized);
            if (targetUuid == null) {
                Bukkit.getScheduler().runTask(plugin, () ->
                        player.sendMessage("¬ßc‚ùå Code d'ami invalide ou inexistant !"));
                return;
            }

            if (targetUuid.equals(senderUuid)) {
                Bukkit.getScheduler().runTask(plugin, () ->
                        player.sendMessage("¬ßc‚ùå Vous ne pouvez pas utiliser votre propre code !"));
                return;
            }

            final String targetName = fetchPlayerName(targetUuid);
            if (targetName == null) {
                Bukkit.getScheduler().runTask(plugin, () ->
                        player.sendMessage("¬ßc‚ùå Impossible de trouver le joueur associ√© √† ce code."));
                return;
            }

        Bukkit.getScheduler().runTask(plugin, () ->
                processFriendRequest(player, targetUuid, targetName));
        });
    }

    private String getPlayerName(final UUID playerUUID) {
        if (playerUUID == null) {
            return "Joueur-inconnu";
        }

        final Player onlinePlayer = Bukkit.getPlayer(playerUUID);
        if (onlinePlayer != null) {
            return onlinePlayer.getName();
        }

        final DatabaseManager databaseManager = plugin.getDatabaseManager();
        if (databaseManager != null) {
            try {
                final String databaseName = databaseManager.getPlayerName(playerUUID);
                if (databaseName != null && !databaseName.isBlank()) {
                    return databaseName.trim();
                }
            } catch (final Exception exception) {
                plugin.getLogger().warning("Erreur r√©cup√©ration nom pour " + playerUUID + ": "
                        + exception.getMessage());
            }
        }

        try {
            final String offlineName = Bukkit.getOfflinePlayer(playerUUID).getName();
            if (offlineName != null && !offlineName.isBlank()) {
                return offlineName;
            }
        } catch (final Exception exception) {
            plugin.getLogger().warning("Erreur OfflinePlayer pour " + playerUUID + ": " + exception.getMessage());
        }

        return "Joueur-" + playerUUID.toString().substring(0, 8);
    }

    private String getCurrentTimestamp() {
        final java.time.LocalDateTime now = java.time.LocalDateTime.now();
        final java.time.format.DateTimeFormatter formatter =
                java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm");
        return now.format(formatter);
    }

    private void processFriendRequest(final Player sender, final UUID targetUUID, final String targetName) {
        final UUID senderUUID = sender.getUniqueId();

        if (targetUUID.equals(senderUUID)) {
            sender.sendMessage("¬ßc‚ùå Vous ne pouvez pas vous ajouter vous-m√™me !");
            return;
        }

        friendsManager.getFriends(sender)
                .thenCompose(friends -> {
                    if (isAlreadyFriend(friends, targetUUID)) {
                        Bukkit.getScheduler().runTask(plugin, () -> sender.sendMessage("¬ßc‚ùå Vous √™tes d√©j√† amis avec ¬ße" + targetName + "¬ßc !"));
                        return CompletableFuture.completedFuture(null);
                    }

                    return friendsManager.getPendingRequests(sender).thenCompose(requests -> {
                        if (hasIncomingRequest(requests, targetUUID)) {
                            Bukkit.getScheduler().runTask(plugin, () -> sender.sendMessage("¬ßc‚ùå Une demande de ¬ße" + targetName + "¬ßc est d√©j√† en attente !"));
                            return CompletableFuture.completedFuture(null);
                        }

                        return hasOutgoingRequest(sender, targetUUID).thenCompose(hasOutgoing -> {
                            if (hasOutgoing) {
                                Bukkit.getScheduler().runTask(plugin, () -> sender.sendMessage("¬ßc‚ùå Vous avez d√©j√† envoy√© une demande √† ¬ße" + targetName + "¬ßc !"));
                                return CompletableFuture.completedFuture(null);
                            }

                            return friendsManager.sendFriendRequest(sender, targetName, "Demande d'ami");
                        });
                    });
                })
                .thenAccept(success -> {
                    if (success == null) {
                        return;
                    }

                    if (success) {
                        Bukkit.getScheduler().runTask(plugin, () -> {
                            sender.sendMessage("¬ßa‚úÖ Demande d'ami envoy√©e √† ¬ß2" + targetName + "¬ßa !");
                            sender.sendMessage("¬ß7La demande expire dans ¬ßa7 jours");

                            final Player target = Bukkit.getPlayer(targetUUID);
                            if (target != null) {
                                target.sendMessage("¬ßeüì¨ ¬ß6" + sender.getName() + "¬ße vous a envoy√© une demande d'ami !");
                                target.sendMessage("¬ß7Tapez ¬ßa/friend accept " + sender.getName() + "¬ß7 pour accepter");
                                target.sendMessage("¬ß7Ou ouvrez le menu amis ¬ßa/friends");
                                target.playSound(target.getLocation(), "entity.experience_orb.pickup", 1.0f, 1.2f);
                            }

                            if (plugin.getMenuUpdateManager() != null) {
                                plugin.getMenuUpdateManager().forceUpdate(sender);
                                if (target != null) {
                                    plugin.getMenuUpdateManager().forceUpdate(target);
                                }
                            }
                        });
                        return;
                    }

                    Bukkit.getScheduler().runTask(plugin, () -> {
                        sender.sendMessage("¬ßc‚ùå Erreur lors de l'envoi de la demande !");
                        sender.sendMessage("¬ß7Veuillez r√©essayer plus tard");
                    });
                })
                .exceptionally(exception -> {
                    plugin.getLogger().severe("Erreur lors de l'envoi de demande d'ami: " + exception.getMessage());
                    Bukkit.getScheduler().runTask(plugin, () -> sender.sendMessage("¬ßc‚ùå Erreur lors de l'envoi de la demande !"));
                    return null;
                });
    }

    public void enableAddMode(final Player player, final String mode) {
        final UUID playerUUID = player.getUniqueId();
        pendingRequests.put(playerUUID, mode);

        switch (mode) {
            case MODE_SEARCH_PLAYER_NAME -> {
                player.sendMessage("¬ßeüîç ¬ß6Tapez le nom exact du joueur √† ajouter:");
                player.sendMessage("¬ß7Exemple: ¬ßaSteve ¬ß7ou ¬ßaPlayer123");
                player.sendMessage("¬ß7Tapez ¬ßc'annuler'¬ß7 pour annuler");
            }
            case MODE_FRIEND_CODE -> {
                player.sendMessage("¬ßdüíæ Ajout via code d'ami activ√© !");
                player.sendMessage("¬ß7Saisissez un code au format ¬ßdXXXX-YYYY¬ß7.");
                player.sendMessage("¬ß7Tapez ¬ßc'annuler'¬ß7 pour annuler");

                final FriendCodeManager codeManager = plugin.getFriendCodeManager();
                if (codeManager == null) {
                    player.sendMessage("¬ßc‚ùå Le syst√®me de codes d'amis est indisponible.");
                    break;
                }

                Bukkit.getScheduler().runTaskAsynchronously(plugin, () -> {
                    String code = codeManager.getPlayerCode(playerUUID);
                    if (code == null) {
                        code = codeManager.generateUniqueCode(playerUUID);
                    }
                    final String resolvedCode = code;
                    Bukkit.getScheduler().runTask(plugin, () -> {
                        if (!player.isOnline()) {
                            return;
                        }
                        if (!MODE_FRIEND_CODE.equals(pendingRequests.get(playerUUID))) {
                            return;
                        }
                        if (resolvedCode != null) {
                            player.sendMessage("¬ßd‚ñ∏ Votre code : ¬ßf" + resolvedCode);
                        } else {
                            player.sendMessage("¬ßc‚ùå Impossible de r√©cup√©rer votre code d'ami pour le moment.");
                        }
                    });
                });
            }
            default -> player.sendMessage("¬ßc‚ùå Mode d'ajout non reconnu !");
        }

        Bukkit.getScheduler().runTaskLater(plugin, () -> {
            if (pendingRequests.containsKey(playerUUID)) {
                pendingRequests.remove(playerUUID);
                player.sendMessage("¬ßc‚è∞ Temps d'attente √©coul√© - Ajout d'ami annul√©");
            }
        }, 20L * 30);
    }

    public void enableFriendCodeMode(final Player player) {
        enableAddMode(player, MODE_FRIEND_CODE);
    }

    private String normalizeFriendCode(final String input) {
        if (input == null) {
            return null;
        }

        String sanitized = input.trim().toUpperCase(Locale.ROOT).replace(" ", "");
        if (sanitized.length() == 8 && !sanitized.contains("-")) {
            sanitized = sanitized.substring(0, 4) + "-" + sanitized.substring(4);
        }

        if (!sanitized.matches("[A-Z0-9]{4}-[A-Z0-9]{4}")) {
            return null;
        }

        return sanitized;
    }

    private String fetchPlayerName(final UUID uuid) {
        final DatabaseManager databaseManager = plugin.getDatabaseManager();
        if (databaseManager == null) {
            return null;
        }

        final String query = "SELECT username FROM players WHERE uuid = ? ORDER BY last_seen DESC LIMIT 1";
        try (Connection connection = databaseManager.getConnection();
             PreparedStatement statement = connection.prepareStatement(query)) {
            statement.setString(1, uuid.toString());
            try (ResultSet resultSet = statement.executeQuery()) {
                if (resultSet.next()) {
                    return resultSet.getString("username");
                }
            }
        } catch (final SQLException exception) {
            plugin.getLogger().severe("Erreur recherche nom pour UUID " + uuid + ": " + exception.getMessage());
        }

        return null;
    }

    private UUID getPlayerUUID(final String playerName) {
        final Player onlinePlayer = Bukkit.getPlayerExact(playerName);
        if (onlinePlayer != null) {
            return onlinePlayer.getUniqueId();
        }

        final DatabaseManager databaseManager = plugin.getDatabaseManager();
        if (databaseManager != null) {
            final UUID databaseUuid = databaseManager.getPlayerUUID(playerName);
            if (databaseUuid != null) {
                return databaseUuid;
            }
        }

        try {
            return Bukkit.getOfflinePlayer(playerName).getUniqueId();
        } catch (final Exception exception) {
            plugin.getLogger().warning("Impossible de trouver l'UUID pour " + playerName + ": " + exception.getMessage());
            return null;
        }
    }

    public boolean isInAddMode(final Player player) {
        return pendingRequests.containsKey(player.getUniqueId());
    }

    public void cancelAddMode(final Player player) {
        if (pendingRequests.remove(player.getUniqueId()) != null) {
            player.sendMessage("¬ßc‚ùå Ajout d'ami annul√©");
        }
    }

    private boolean isAlreadyFriend(final List<FriendData> friends, final UUID targetUUID) {
        if (friends == null) {
            return false;
        }
        final String target = targetUUID.toString();
        return friends.stream().anyMatch(data -> target.equalsIgnoreCase(data.getUuid()));
    }

    private boolean hasIncomingRequest(final List<FriendRequest> requests, final UUID targetUUID) {
        if (requests == null) {
            return false;
        }
        final String target = targetUUID.toString();
        return requests.stream().anyMatch(request -> target.equalsIgnoreCase(request.getSenderUuid()));
    }

    private CompletableFuture<Boolean> hasOutgoingRequest(final Player sender, final UUID targetUUID) {
        final Player target = Bukkit.getPlayer(targetUUID);
        if (target == null) {
            return CompletableFuture.completedFuture(false);
        }

        return friendsManager.getPendingRequests(target).thenApply(requests -> {
            if (requests == null) {
                return false;
            }
            final String senderId = sender.getUniqueId().toString();
            return requests.stream().anyMatch(request -> senderId.equalsIgnoreCase(request.getSenderUuid()));
        });
    }
}
